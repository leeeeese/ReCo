flowchart TB

    %% =======================
    %% 1) INPUT & SHARED STATE
    %% =======================
    subgraph SharedState["Global State (Graph State)"]
        userQuery["user_query"]
        persona["persona"]
        itemCandidates["item_candidates"]
        priceResult["price_result"]
        safetyResult["safety_result"]
        finalRanking["final_ranking"]
    end

    %% =======================
    %% 2) INIT NODE
    %% =======================
    initNode["Init Node
    - Query normalization
    - Category parsing
    - Persona detection
    Output:
      persona, parsed_query"]

    %% =======================
    %% 3) PRODUCT AGENT
    %% =======================
    subgraph ProductAgent["Product Agent Node"]
        productReason["Reasoning (ReAct)
        - product_prompt
        - 3 core analyses:
          - Quality pattern
          - Price strategy
          - Seller profiling"]
        productTools["Tools:
        - VectorDB search
        - Product DB lookup
        - Market price tool
        - LLM reasoning (OpenAI)"]
        productOutput["Output:
        product_result (score, reasoning, seller_characteristics)"]
    end

    %% =======================
    %% 4) RELIABILITY AGENT
    %% =======================
    subgraph ReliabilityAgent["Reliability Agent Node"]
        reliabilityReason["Reasoning (ReAct)
        - reliability_prompt
        - 4 core analyses:
          - Transaction behavior
          - Review personality
          - Trustworthiness
          - Activity & credibility"]
        reliabilityTools["Tools:
        - Seller DB lookup
        - Review analyzer
        - Risk pattern checker
        - LLM reasoning (OpenAI)"]
        reliabilityOutput["Output:
        reliability_result (score, seller_profile_summary, reasoning)"]
    end

    %% =======================
    %% 5) ORCHESTRATOR AGENT
    %% =======================
    subgraph Orchestrator["Orchestrator Agent"]
        mergeNode["Aggregation Logic:
        - Integrate multi-agent outputs
        - Fusion of value & reliability scores
        - Weighted ranking
        - Buyer-seller matching optimization"]
        finalOutput["Output:
        final_ranking (top-K recommendations)"]
    end

    %% =======================
    %% DATA FLOW
    %% =======================

    userQuery --> initNode --> persona

    initNode --> productReason
    initNode --> reliabilityReason

    productReason --> productTools --> productOutput --> productResult
    reliabilityReason --> reliabilityTools --> reliabilityOutput --> reliabilityResult

    productResult --> mergeNode
    reliabilityResult --> mergeNode

    mergeNode --> finalOutput --> finalRanking
