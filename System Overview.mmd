---
config:
  theme: default
  layout: elk
---
flowchart TB
  subgraph PresentationLayer["Presentation Layer / Frontend UI"]
    user["사용자 입력 / Browser UI<br/>(자연어: '친절한 판매자가 파는 가격이 싼 아이폰 14')"]
    reactUI["React Frontend<br/>Session & UI Rendering<br/>Tailwind CSS + TypeScript"]
  end
  
  subgraph ApplicationLayer["Application Layer / FastAPI Backend"]
    fastapi["FastAPI Backend<br/>Request Routing & CORS<br/>Timeout: 240s (워크플로우), 30s (채팅)"]
    initNode["Init Node<br/>검색 쿼리 생성<br/>대화 컨텍스트 추가"]
    chatEndpoint["Chat Endpoint<br/>일반 대화 처리<br/>gpt-4o-mini (30s)"]
  end
  
  subgraph ReasoningLayer["Reasoning Layer / LangGraph Agentic Pipeline"]
    product["Product Agent<br/>상품 특성 분석<br/>gpt-4o-mini<br/><br/>- 가격/할인율 기준<br/>- 모든 카테고리 조회<br/>- 검색어 필터 없음"]
    reliability["Reliability Agent<br/>신뢰도 분석<br/>gpt-4o-mini<br/><br/>- 리뷰/거래 기록 기준<br/>- 모든 카테고리 조회<br/>- 검색어 필터 없음"]
    orchestrator["Orchestrator Agent<br/>최종 통합 & 선택<br/>gpt-5-mini<br/><br/>- 사용자 의도 파악<br/>- '친절' + '가격 싼' + '아이폰 14'<br/>- 최종 판매자 선택"]
    ruleMatch["Rule-based Matching<br/>선택된 판매자의<br/>상품 매칭<br/>(최대 5개/판매자)"]
  end
  
  subgraph DataLayer["Data Layer"]
    db["SQLite Database<br/>Product, Seller, Review<br/>Conversation History"]
  end
  
  subgraph External["External Systems"]
    llm["OpenAI API<br/>gpt-5-mini: Orchestrator<br/>gpt-4o-mini: Sub-agents & Chat"]
  end
  
  %% Flow for Recommendation
  user -- "상품 추천 요청" --> reactUI
  reactUI -- "POST /api/v1/recommend" --> fastapi
  fastapi --> initNode
  initNode -- "병렬 실행" --> product
  initNode -- "병렬 실행" --> reliability
  
  product -- "모든 판매자 조회<br/>(검색어 필터 X)" --> db
  reliability -- "모든 판매자 조회<br/>(검색어 필터 X)" --> db
  
  product -- "LLM 분석" --> llm
  reliability -- "LLM 분석" --> llm
  
  product -- "가격 좋은 판매자 47명" --> orchestrator
  reliability -- "신뢰도 좋은 판매자 47명" --> orchestrator
  
  orchestrator -- "사용자 의도 분석" --> llm
  orchestrator -- "최종 판매자 선택" --> ruleMatch
  
  ruleMatch -- "상품 매칭" --> db
  ruleMatch -- "상위 10개 결과" --> fastapi
  
  %% Flow for Chat
  user -- "일반 대화" --> reactUI
  reactUI -- "POST /api/v1/chat" --> chatEndpoint
  chatEndpoint -- "LLM 대화" --> llm
  chatEndpoint -- "응답" --> reactUI
  
  fastapi -- "JSON Response" --> reactUI
  reactUI -- "결과 표시" --> user
  
  style orchestrator fill:#e1f5e1
  style product fill:#fff4e1
  style reliability fill:#fff4e1
  style chatEndpoint fill:#e1e8f5
